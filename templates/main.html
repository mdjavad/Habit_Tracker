<!DOCTYPE html>
{% load static %}
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>Habit Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'main.css' %}">

  <!-- Firebase SDK v8.6.3 -->
  <script src="https://www.gstatic.com/firebasejs/8.6.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.3/firebase-messaging.js"></script>

  <script>
    // Firebase configuration (from your project)
    var firebaseConfig = {
      apiKey: "AIzaSyAdGLgTWNFB91sq_3vascE_E-Z4_dshBxU",
      authDomain: "habit-tracker-2a428.firebaseapp.com",
      projectId: "habit-tracker-2a428",
      storageBucket: "habit-tracker-2a428.firebasestorage.app",
      messagingSenderId: "890703119462",
      appId: "1:890703119462:web:6aa6ad70f36548af5359a7",
      measurementId: "G-EDY64CGP50"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // Register the service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/firebase-messaging-sw.js")
        .then((registration) => {
          console.log("Service Worker registered:", registration);

          messaging.useServiceWorker(registration);

          // Request permission and get token
          messaging.requestPermission()
            .then(() => {
              console.log("Notification permission granted.");
              return messaging.getToken();
            })
            .then((token) => {
              console.log("FCM Token:", token);
              // Send token to Django backend
              fetch("/save-fcm-token/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ token: token })
              });
            })
            .catch((err) => {
              console.error("Unable to get permission to notify.", err);
            });
        })
        .catch((err) => {
          console.error("Service Worker registration failed:", err);
        });
    }

    // Foreground message handler
    messaging.onMessage(function (payload) {
      console.log("Foreground message:", payload);
      alert(payload.notification.title + "\n" + payload.notification.body);
    });
  </script>
</head>

<body>
  {% include 'navbar.html' %}

  <!-- Toast Notifications -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div class="toast-container position-fixed top-0 end-0 p-3">
      {% if messages %}
        {% for message in messages %}
          <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">{{ message }}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  {% block content %}
  {% endblock %}

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Show toast messages -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toastElList = [].slice.call(document.querySelectorAll('.toast'));
      toastElList.map(function (toastEl) {
        new bootstrap.Toast(toastEl, { delay: 5000 }).show();
      });
    });
  </script>
</body>
</html>
